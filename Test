import pandas as pd

input_file = "your_input_file.xlsx"
output_file = "your_output_file.xlsx"

df = pd.read_excel(input_file)

df["Owner"] = df["Owner"].fillna("Unassigned")
df["Internal/External"] = df["Folder"].apply(lambda x: "External" if "external" in str(x).lower() else "Internal")

signing_keywords = ["MC CA Signing", "Pre Approved", "Public CA Signing", "Third Party Handling", "External"]
df["Signing Type"] = "OTHER"
for keyword in signing_keywords:
    df.loc[df["Folder"].str.contains(keyword, case=False, na=False), "Signing Type"] = keyword

type_keywords = ["JKS", "APACHE", "F5", "PEM", "PKCS", "BASIC", "ADAPTABLE", "DESKTOP"]
df["Type"] = "OTHER"
for keyword in type_keywords:
    df.loc[df["Installation Type"].str.contains(keyword, case=False, na=False), "Type"] = keyword
df.loc[df["Type"] == "OTHER", "Type"] = df["Installation Type"].str.split("-").str[0]

df["Server name"] = df["Device"].str.split("(").str[0].str.strip()
df["Domain"] = df["Common Name"].apply(lambda x: "MC Domain" if "mastercard" in str(x).lower() else "NON MC Domain")

df["Stage"] = df["Status"].apply(lambda x: "Cert Secured" if str(x).lower() == "completed" else ("Phased Out" if str(x).lower() == "none" else ""))
df["CURRENT STATUS"] = df["Status"].apply(lambda x: "Renewed" if str(x).lower() == "completed" else ("Retired" if str(x).lower() == "none" else "Expiring"))

df["MC Prod ID"] = df["Comments"].str.extract(r"(MCProd\w+)", expand=False)
df["WO number"] = df["Comments"].str.extract(r"(WO\d{12})", expand=False)
df["CRQ number"] = df["Comments"].str.extract(r"(CRQ\d{12})", expand=False)

df.loc[(df["Type"] == "F5") & (df["Domain"] == "MC Domain"), ["Stage", "CURRENT STATUS"]] = ["AUTOMATION", "AUTOMATED"]

df = df.groupby("Nickname", as_index=False).agg({
    "Owner": "first",
    "Environment": "first",
    "Internal/External": "first",
    "Valid To": "first",
    "Signing Type": "first",
    "Type": "first",
    "Server name": lambda x: ", ".join(x.dropna().unique()),
    "Domain": "first",
    "Stage": "first",
    "MC Prod ID": "first",
    "WO number": "first",
    "CRQ number": "first",
    "Comments": "first",
    "Serial number": "first",
    "New Serial number": "first",
    "CURRENT STATUS": "first",
    "Folder": "first",
    "Common Name": "first",
    "Key Size": "first",
    "Issuer": "first",
    "Program Name": "first",
    "Contact": "first",
    "Installations": "first",
    "Installation Type": "first",
    "Device": "first"
})

manual_certs = df[df["Stage"] != "AUTOMATION"]
automated_certs = df[df["Stage"] == "AUTOMATION"]

with pd.ExcelWriter(output_file) as writer:
    manual_certs.to_excel(writer, sheet_name="Manual Certs", index=False)
    automated_certs.to_excel(writer, sheet_name="Automated Certs", index=False)

print("Processing complete. File saved as:", output_file)
