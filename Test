import os
import pandas as pd

# Input: Base Path
base_path = r""  # Provide the path where CERA_AUTO_ALERTS is located

# Load Excel File
acc_template_path = os.path.join(base_path, "ACC_Template", "ACC_Template.xlsx")
xls = pd.ExcelFile(acc_template_path)

# Read Alert HQ and Alert Blueprint sheets
alert_hq = xls.parse("Alert HQ", header=None)
alert_blueprint = xls.parse("Alert Blueprint")

# Step 1: Extract values from Alert HQ
feature_num = str(alert_hq.iloc[0, 1]).strip()  # B1
env_list = str(alert_hq.iloc[2, 1]).strip().split(",")  # B3 (comma-separated envs)

# Step 2: Create Feature Folder
feature_folder = os.path.join(base_path, feature_num)
os.makedirs(feature_folder, exist_ok=True)
print(f"Feature folder created: {feature_folder}")

# Step 3: Create Environment Folders
env_folders = {}
for env in env_list:
    env_path = os.path.join(feature_folder, env.strip())
    os.makedirs(env_path, exist_ok=True)
    env_folders[env.strip()] = env_path
    print(f"Environment folder created: {env_path}")

# Step 4: Copy and Rename Excel File
renamed_excel_path = os.path.join(feature_folder, f"ACC_{feature_num}.xlsx")
os.system(f'copy "{acc_template_path}" "{renamed_excel_path}"')
print(f"Excel file copied and renamed to: {renamed_excel_path}")

# Step 5: Generate SPL Files
start_id = input("Enter starting CERA ID (5-digit): ").strip()
if not start_id.isdigit() or len(start_id) != 5:
    raise ValueError("Invalid input! CERA ID must be a 5-digit number.")

start_id = int(start_id)

# Iterate through each environment
for env in env_list:
    env = env.strip()
    env_path = env_folders[env]

    # Iterate through each row in Alert Blueprint
    for index, row in alert_blueprint.iterrows():
        title = row["Title"].strip()
        severity = row["Severity"].strip()
        query = row["Log Message/Query"]

        # Insert environment in query
        if 'cf_space_name=""' in query:
            query = query.replace('cf_space_name=""', f'cf_space_name="{env}"')

        # Generate SPL file name
        spl_id = f"{start_id:05d}"  # Ensure 5-digit ID
        spl_filename = f"CERA-APP-{spl_id}-{severity}-{env}-test-{title}.spl"
        spl_filepath = os.path.join(env_path, spl_filename)

        # Write query to SPL file
        with open(spl_filepath, "w") as spl_file:
            spl_file.write(query)

        print(f"SPL file created: {spl_filepath}")
        start_id += 1  # Increment ID for next file

# Step 6: Print Summary
total_files = len(env_list) * len(alert_blueprint)
print(f"\nTotal SPL files created: {total_files}")
