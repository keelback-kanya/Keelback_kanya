import openpyxl
from openpyxl import Workbook

input_file = "your_input_file.xlsx"
output_file = "your_output_file.xlsx"

wb = openpyxl.load_workbook(input_file)
sheet = wb.active

headers = [cell.value for cell in sheet[1]]
data = []

for row in sheet.iter_rows(min_row=2, values_only=True):
    data.append(dict(zip(headers, row)))

manual_certs = []
automated_certs = []

for row in data:
    owner = row.get("Owner", "").strip() or "Unassigned"
    nickname = row.get("Nickname", "").strip()
    server_name = row.get("Server name", "").strip()
    status = row.get("Status", "").strip().lower()
    stage = row.get("Stage", "").strip().lower()
    crq = ""
    wo = ""

    comments = row.get("Comments", "")
    for word in comments.split():
        if word.startswith("CRQ") and len(word) == 15:
            crq = word
        elif word.startswith("WO") and len(word) == 15:
            wo = word

    row.update({"Owner": owner, "CRQ number": crq, "WO number": wo})

    if owner == "Unassigned":
        row["Status"] = "Expiring"
        row["Stage"] = "Expiring"

    if status == "automated" and stage == "automation":
        automated_certs.append(row)
    else:
        manual_certs.append(row)

output_wb = Workbook()
manual_sheet = output_wb.active
manual_sheet.title = "Manual Certs"
automated_sheet = output_wb.create_sheet("Automated Certs")

manual_sheet.append(headers)
for row in manual_certs:
    manual_sheet.append([row.get(col, "") for col in headers])

automated_sheet.append(headers)
for row in automated_certs:
    automated_sheet.append([row.get(col, "") for col in headers])

output_wb.save(output_file)
print(f"Processing complete. File saved as: {output_file}")
